name: Build and Test

on:
  pull_request:
    branches:
      - main
  push:
    branches-ignore:
      - main

jobs:
  test-backend:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./backend
        run: go mod download

      - name: ğŸ” Run go fmt
        working-directory: ./backend
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted. Run 'go fmt ./...'"
            gofmt -l .
            exit 1
          fi

      - name: ğŸ” Run go vet
        working-directory: ./backend
        run: go vet ./...

      - name: ğŸ—ï¸ Build backend
        working-directory: ./backend
        run: go build -v ./cmd/server

      - name: âœ… Backend build successful
        run: echo "âœ… Backend built successfully"

  test-flutter:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./frontend
        run: flutter pub get

      - name: ğŸ” Analyze Flutter code
        working-directory: ./frontend
        run: flutter analyze

      - name: ğŸ—ï¸ Build Flutter app
        working-directory: ./frontend
        run: flutter build apk --debug

      - name: âœ… Flutter build successful
        run: echo "âœ… Flutter built successfully"

  docker-build-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Test Docker build
        run: |
          docker build -t bstock-backend-test ./backend
          echo "âœ… Docker image built successfully"
